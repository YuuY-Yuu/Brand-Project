<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•å°Šæ¦®å“ç‰ŒæŸ¥è©¢ç³»çµ±</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    /* ==================== 1. åŸºç¤æ¨£å¼ (é‚„åŸè–èª•ç´…é¢¨æ ¼ + æ–°å­—é«”) ==================== */
    body {
        /* ä¿ç•™æ‚¨å–œæ­¡çš„æ–°å­—é«” */
        font-family: 'Noto Serif TC', 'Microsoft JhengHei', serif;
        background-color: #fff0f0; /* é‚„åŸç²‰ç´…èƒŒæ™¯ */
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        margin: 0;
        padding: 40px 0;
    }

    .container {
        background: white;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(176, 0, 32, 0.1);
        width: 90%;
        max-width: 1000px;
        position: relative;
        border-top: 8px solid #B00020; /* é‚„åŸç´…è‰²é ‚éƒ¨ */
        margin-bottom: 50px;
    }

    h2 {
        text-align: center;
        color: #B00020;
        /* æ¨™é¡Œä½¿ç”¨æ–°å­—é«” */
        font-family: 'Noto Serif TC', serif;
        font-size: 2.2rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #FFD700;
        padding-bottom: 15px;
        font-weight: 700;
    }

    h3 {
        color: #B00020;
        margin-top: 0;
        font-size: 1.4rem;
        margin-bottom: 15px;
        font-family: 'Noto Serif TC', serif;
    }

    /* ==================== 2. è¼ªæ’­ç‰† (é‚„åŸèˆŠç‰ˆæ¨£å¼) ==================== */
    .carousel-section {
        position: relative;
        margin: 20px 0;
        width: 100%;
        height: 340px;
        overflow: hidden;
        display: block;
    }

    .mall-track {
        display: flex;
        align-items: center;
        height: 100%;
        position: absolute;
        left: 0;
        will-change: transform;
    }

    .mall-card {
        width: 250px;
        height: 180px;
        background: linear-gradient(135deg, #ffffff 0%, #fffbf0 100%);
        border-radius: 15px;
        border: 2px solid #eee;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 15px;
        margin-right: 25px;
        box-sizing: border-box;
        opacity: 0.5;
        transform: scale(0.9);
        filter: blur(1px);
        transition: opacity 0.5s, transform 0.5s, filter 0.5s;
        pointer-events: none;
        user-select: none;
        flex-shrink: 0;
    }

    /* Active å¡ç‰‡é‚„åŸæˆæ‚¨åŸæœ¬ç¿’æ…£çš„ç´…æ¡†é‡‘é‚Š */
    .mall-card.active {
        opacity: 1 !important;
        transform: scale(1.15) !important;
        filter: blur(0) !important;
        border: 3px solid #FFD700 !important;
        box-shadow: 0 15px 40px rgba(176, 0, 32, 0.25);
        z-index: 10;
        pointer-events: auto;
        cursor: pointer;
        background: white;
    }

    .mall-card h4 {
        color: #B00020;
        margin: 0 0 10px 0;
        font-size: 1.3rem;
        pointer-events: none;
        font-family: 'Noto Serif TC', serif; /* å¡ç‰‡æ¨™é¡Œä¹Ÿç”¨æ–°å­—é«” */
    }

    .mall-card p {
        color: #666;
        font-size: 0.9rem;
        margin: 0;
        pointer-events: none;
    }

    .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(176, 0, 32, 0.9);
        color: white;
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 50;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transition: transform 0.2s, background 0.2s;
    }
    .nav-btn:hover { background: #D32F2F; transform: translateY(-50%) scale(1.1); }
    .prev-btn { left: 15px; }
    .next-btn { right: 15px; }

    /* ==================== 3. æœå°‹ä»‹é¢ (é‚„åŸèˆŠç‰ˆ) ==================== */
    .search-box {
        background: #fffbf0;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 30px;
        border: 1px solid #FFD700;
    }

    .search-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
    .input-group { flex: 1; min-width: 200px; position: relative; }
    label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }

    input, select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        box-sizing: border-box;
        outline: none;
        font-family: 'Noto Serif TC', sans-serif; /* è¼¸å…¥æ¡†ä¹Ÿç”¨æ–°å­—é«” */
    }
    input:focus, select:focus { border-color: #B00020; }

    .btn-group { display: flex; gap: 10px; }
    button {
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: 0.3s;
        font-family: 'Noto Serif TC', serif;
    }
    .btn-search { background-color: #B00020; color: white; }
    .btn-search:hover { background-color: #8C0018; transform: translateY(-2px); }

    /* ==================== 4. AI è¦–çª— (ä¿ç•™æ–°ç‰ˆé…è‰²ï¼) ==================== */
    /* æŒ‰éˆ•ï¼šé¦™æª³é‡‘ */
    .btn-ai {
        background: #F5EFEB; 
        color: #8E1600;
        border: 1px solid #E6DCD0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .btn-ai:hover { background: #EADCD0; transform: translateY(-2px); }

    .clear-btn {
        position: absolute; right: 12px; top: 40px; background: #ddd; color: white; width: 22px; height: 22px;
        border-radius: 50%; text-align: center; line-height: 22px; cursor: pointer; display: none; font-size: 14px;
    }
    .clear-btn:hover { background: #B00020; }

    /* ==================== 5. æœå°‹çµæœå¡ç‰‡ (é‚„åŸèˆŠç‰ˆ) ==================== */
    .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 25px; }
    
    .result-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border-left: 6px solid #B00020;
        padding: 20px;
        transition: 0.3s;
        position: relative;
    }
    .result-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
    .result-card h4 { margin: 0 0 10px 0; color: #B00020; font-size: 1.3rem; font-family: 'Noto Serif TC', serif; }
    .result-card .info { color: #555; font-size: 0.95rem; margin: 5px 0; line-height: 1.5; }
    .result-card .match-box { background: #fff5f5; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px dashed #B00020; }
    .result-card .match-title { font-weight: bold; color: #B00020; font-size: 0.9rem; margin-bottom: 5px; }
    .brand-tag { display: inline-block; background: #FFD700; color: #B00020; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; margin-right: 5px; margin-bottom: 5px; }

    /* ==================== 6. AI Modal (ä¿ç•™æ–°ç‰ˆæ¨£å¼) ==================== */
    #aiModal {
        display: none;
        position: fixed; bottom: 20px; right: 20px; width: 360px; height: 520px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15); /* é™°å½±è¼ƒæŸ”å’Œ */
        z-index: 3000;
        flex-direction: column;
        border: 2px solid #D4AF37; /* é¦™æª³é‡‘é‚Šæ¡† */
        overflow: hidden;
        font-family: 'Noto Serif TC', serif;
    }
    .ai-header { 
        background: #8E1600; /* æ·±é…’ç´… */
        color: white; 
        padding: 15px; 
        display: flex; justify-content: space-between; align-items: center; 
        font-weight: bold; 
    }
    .ai-body { flex: 1; padding: 15px; overflow-y: auto; background: #fffcfc; display: flex; flex-direction: column; gap: 12px; }
    .ai-footer { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; background: white; }
    .msg { padding: 10px 14px; border-radius: 15px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
    .msg-ai { background: #F5EFEB; color: #333; align-self: flex-start; } /* ç±³è‰²å°è©±æ¡† */
    .msg-user { background: #8E1600; color: white; align-self: flex-end; } /* é…’ç´…å°è©±æ¡† */

    /* å…¶ä»–ä¿ç•™ (æ‰‹æ©Ÿç‰ˆé©æ‡‰ã€æ¨“å±¤æ¨£å¼) */
    #floorView { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #fffbf0; z-index: 2000; }
    .floor-layout { display: flex; width: 100%; height: 100%; }
    .floor-sidebar-container { width: 220px; background: #2c3e50; border-right: 4px solid #B00020; display: flex; flex-direction: column; flex-shrink: 0; z-index: 2010; }
    .sidebar-header { padding: 15px; border-bottom: 1px solid #444; background: #2c3e50; }
    .close-floor-btn { width: 100%; background: #c0392b; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: bold; }
    .close-floor-btn:hover { background: #e74c3c; }
    .floor-btn-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column-reverse; padding-bottom: 50px; justify-content: center; }
    .floor-btn { padding: 18px 10px; text-align: center; cursor: pointer; font-weight: bold; font-family: 'Georgia', serif; font-size: 1.2rem; border-bottom: 1px solid #444; transition: all 0.2s; color: #ccc; }
    .floor-btn:hover { background: #444; color: white; }
    .floor-btn.active { background: #B00020; color: #FFD700; font-size: 1.5rem; box-shadow: inset 0 0 15px rgba(0,0,0,0.4); }
    .floor-content { flex: 1; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
    .floor-header-sticky { position: sticky; top: 0; background: #fffbf0; z-index: 2005; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
    .floor-search-container { display: flex; align-items: center; position: relative; width: 360px; gap: 10px; }
    .floor-search-input-wrapper { flex: 1; position: relative; }
    .floor-search-input { width: 100%; padding: 12px 40px 12px 20px; border: 2px solid #ddd; border-radius: 25px; outline: none; font-size: 1rem; }
    .floor-search-input:focus { border-color: #B00020; }
    .floor-search-clear { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; font-weight: bold; display: none; }
    .floor-search-clear:hover { color: #B00020; }
    .btn-floor-query { background-color: transparent; color: #2c3e50; border: 2px solid #ddd; border-radius: 50%; width: 48px; height: 48px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; flex-shrink: 0; }
    .btn-floor-query:hover { background-color: #f4f4f4; transform: scale(1.05); }
    .floor-grid-container { padding: 30px; }
    .brand-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
    .brand-box { aspect-ratio: 1 / 1; background: white; border: 1px solid #e0e0e0; border-radius: 6px; display: flex; justify-content: center; align-items: center; text-align: center; padding: 8px; font-size: 0.9rem; font-weight: 500; color: #333; transition: all 0.3s; cursor: default; }
    .brand-box:hover { transform: translateY(-3px); border: 2px solid #B00020; color: #B00020; }
    .brand-box.highlight-brand { background-color: #fff3e0; border: 3px solid #e65100; color: #e65100; transform: scale(1.15); box-shadow: 0 0 20px rgba(230, 81, 0, 0.4); font-weight: bold; z-index: 10; }
    @media (max-width: 900px) { .floor-sidebar-container { width: 100px; } .floor-header-sticky { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; } .floor-search-container { width: 100%; } }
</style>
    
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

</head>
<body>

<div class="container" id="mainView">
    <h2>âœ¨ è–èª•å°Šæ¦®å“ç‰ŒæŸ¥è©¢ç³»çµ±</h2>

    <div class="carousel-section" id="carouselContainer">
        <button class="nav-btn prev-btn" onclick="moveCarousel(-1)">â®</button>
        <div class="mall-track" id="mallTrack">
            </div>
        <button class="nav-btn next-btn" onclick="moveCarousel(1)">â¯</button>
    </div>

    <div class="search-box">
        <h3>ğŸ” æ‰¾å“ç‰Œ / æ‰¾ç™¾è²¨</h3>
        <div class="search-row">
            <div class="input-group" style="flex: 0.4;">
                <label>é¸æ“‡åœ°å€</label>
                <select id="citySelect">
                    <option value="All">å…¨å°æœå°‹</option>
                    <option value="Taipei">è‡ºåŒ—</option>
                    <option value="NewTaipei">æ–°åŒ—</option>
                    <option value="Taoyuan">æ¡ƒåœ’</option>
                </select>
            </div>
            <div class="input-group" style="flex: 1.2;">
                <label>è¼¸å…¥å“ç‰Œ</label>
                <input type="text" id="brandInput" placeholder="è¼¸å…¥å“ç‰Œåç¨±..." oninput="checkInput()" onkeypress="if(event.key==='Enter') smartSearch()">
                <div id="clearBtn" class="clear-btn" onclick="clearInput()">âœ•</div>
            </div>
            <div class="btn-group">
                <button class="btn-search" onclick="smartSearch()">ç«‹å³æŸ¥è©¢</button>
                <button class="btn-ai" onclick="toggleAI()">ğŸª„ AI è©¢å•</button>
            </div>
        </div>
        <div id="resultArea" class="card-container"></div>
    </div>
</div>

<div id="floorView">
    <div class="floor-layout">
        <div class="floor-sidebar-container">
            <div class="sidebar-header">
                <button class="close-floor-btn" onclick="closeFloorView()">â† é€€å‡ºå°è¦½</button>
            </div>
            <div class="floor-btn-list" id="floorBtnList"></div>
        </div>

        <div class="floor-content">
            <div class="floor-header-sticky">
                <div>
                    <h2 id="floorTitle" style="margin:0; border:none; text-align:left; font-size:1.7rem;">ç™¾è²¨åç¨±</h2>
                    <span style="color:#666;">ç›®å‰æ¨“å±¤ï¼š</span>
                    <span id="currentFloorLabel" style="color:#B00020; font-weight:bold; font-size:1.5rem;">1F</span>
                </div>
                <div class="floor-search-container">
                    <div class="floor-search-input-wrapper">
                        <input type="text" id="floorSearchInput" class="floor-search-input" placeholder="åœ¨ç™¾è²¨å…§æœå°‹å“ç‰Œ..." oninput="checkFloorSearch()" onkeypress="if(event.key==='Enter') searchInFloor()">
                        <span id="floorSearchClear" class="floor-search-clear" onclick="clearFloorSearch()">âœ•</span>
                    </div>
                    <button class="btn-floor-query" onclick="searchInFloor()">ğŸ”</button>
                </div>
            </div>
            <div class="floor-grid-container">
                <div id="brandGrid" class="brand-grid"></div>
            </div>
        </div>
    </div>
</div>

<div id="aiModal">
    <div class="ai-header">
        <span>ğŸ¤– è–èª•è³¼ç‰© AI é¡§å•</span>
        <span style="cursor:pointer; font-size:1.2rem;" onclick="toggleAI()">âœ•</span>
    </div>
    <div class="ai-body" id="aiChatBody">
        <div class="msg msg-ai">æ‚¨å¥½ï¼æˆ‘æ˜¯è–èª• AI é¡§å• ğŸ…<br>è³‡æ–™åº«å·²æ›´æ–°ï¼<br>æ‚¨å¯ä»¥å•æˆ‘ï¼šã€Œæ¡ƒåœ’å“ªè£¡æœ‰ Nikeï¼Ÿã€æˆ–ã€Œä¿¡ç¾© A8 æœ‰ä»€éº¼å¥½åƒçš„ï¼Ÿã€</div>
    </div>
    <div class="ai-footer">
        <input type="text" id="aiInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter') sendAiMsg()">
        <button class="btn-search" style="padding: 8px 15px;" onclick="sendAiMsg()">é€å‡º</button>
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:3000';

    /* ============================================================
   å‰ç«¯æ¸¬è©¦æ¨¡å¼ (Mock Mode) - é–‹å•Ÿå¾Œä¸éœ€è¦å¾Œç«¯ä¹Ÿèƒ½è·‘
   ============================================================ */
const USE_MOCK = false; // â¬…ï¸ è¦æ¥å¾Œç«¯æ™‚æ”¹å› false

if (USE_MOCK) {
    window.fetch = async (url) => {
        console.log("Mocking API Call:", url);
        
        // 1. æ¨¡æ“¬ç™¾è²¨æ¸…å–® (æ¸¬è©¦è¼ªæ’­èˆ‡é¦–é æœå°‹)
        if (url.includes('/api/stores') || url.includes('/api/smart-search')) {
            return {
                ok: true,
                json: async () => ({
                    success: true,
                    data: [
                        { name: "æ¡ƒåœ’å¤§æ±Ÿè³¼ç‰©ä¸­å¿ƒ", city: "Taoyuan", address: "æ¡ƒåœ’å¸‚ä¸­å£¢å€ä¸­åœ’è·¯äºŒæ®µ501è™Ÿ", phone: "03-4680999", business_hours: "11:00-22:00", floor_range: "GBF-5F", brand_name: "Nike", floor: "GBF" },
                        { name: "æ¡ƒåœ’çµ±é ˜å»£å ´", city: "Taoyuan", address: "æ¡ƒåœ’å¸‚æ¡ƒåœ’å€ä¸­æ­£è·¯61è™Ÿ", phone: "03-3362688", business_hours: "11:00-21:30", floor_range: "B2-9F", brand_name: "Adidas", floor: "1F" },
                        { name: "å°åŒ—ä¿¡ç¾©æ–°å¤©åœ° A11", city: "Taipei", address: "å°åŒ—å¸‚ä¿¡ç¾©å€æ¾å£½è·¯11è™Ÿ", phone: "02-87801000", business_hours: "11:00-21:30", floor_range: "B2-7F", brand_name: "Zara", floor: "2F" }
                    ]
                })
            };
        }

        // 2. æ¨¡æ“¬æ¨“å±¤è³‡æ–™ (æ¸¬è©¦ GBF æ’åºèˆ‡æ¨™è¨˜æŒä¹…åŒ–)
        if (url.includes('/api/mall-floors')) {
            return {
                ok: true,
                json: async () => ({
                    success: true,
                    data: {
                        "GBF": ["Nike", "Uniqlo", "ç„¡å°è‰¯å“"],
                        "1F": ["Samsung", "Starbucks", "Pandora"],
                        "2F": ["Zara", "H&M"]
                    }
                })
            };
        }

        // 3. æ¨¡æ“¬ AI é¡§å•å›è¦†
        if (url.includes('/api/ai-recommend')) {
            return {
                ok: true,
                json: async () => ({
                    reply: "### ğŸ… è–èª•è³¼ç‰©å»ºè­°\næ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘æ¨è–¦å‰å¾€ **æ¡ƒåœ’å¤§æ±Ÿè³¼ç‰©ä¸­å¿ƒ**ï¼š\n* **ä½ç½®**ï¼šGBF æ¨“å±¤æœ‰ Nikeã€‚\n* **ç‡Ÿæ¥­æ™‚é–“**ï¼š11:00-22:00ã€‚\n\né‚£é‚Šé‚„æœ‰å…¨å°æœ€å¤§çš„ç¾é£Ÿè¡—å–”ï¼"
                })
            };
        }
    };
}

    // ==========================================================================
    // 1. ğŸ¡ [ä¿®æ­£ç‰ˆ] Triple Buffer ç„¡ç¸«è¼ªæ’­å¼•æ“
    // ==========================================================================
    let rawMallData = [];
    let carouselData = [];
    let realCount = 0;
    let currentIndex = 0;
    let isCarouselAnimating = false;
    let autoPlayTimer;

    const CARD_WIDTH = 250;
    const CARD_GAP = 25; // CSS ä¸­çš„ margin-right
    const STEP = CARD_WIDTH + CARD_GAP;

    // åˆå§‹åŒ–
    async function initMallCarousel() {
        try {
            const res = await fetch(`${BASE_URL}/api/stores`);
            const json = await res.json();
            if (!json.success || !json.data) return;
            
            rawMallData = json.data;
            realCount = rawMallData.length;
            if (realCount === 0) return;

            renderCarouselTripleBuffer();
            startAutoPlay();

            // ç›£è½ transition end åšç¬ç§»åˆ¤æ–·
            document.getElementById('mallTrack').addEventListener('transitionend', handleTransitionEnd);
        } catch (err) { console.error("Carousel Init Error:", err); }
    }

    // æ¸²æŸ“ï¼šTriple Buffer [Set 1][Set 2][Set 3]
    function renderCarouselTripleBuffer() {
        const track = document.getElementById('mallTrack');
        
        // è¤‡è£½ä¸‰ä»½
        carouselData = [...rawMallData, ...rawMallData, ...rawMallData];
        
        track.innerHTML = carouselData.map((mall, i) => `
            <div class="mall-card" data-index="${i}" onclick="handleCardClick(this, '${mall.name}')">
                <h4>${mall.name}</h4>
                <p>ğŸ“ ${mall.city}</p>
                <p style="font-size:0.8rem; margin-top:5px; opacity:0.7;">${mall.address}</p>
            </div>
        `).join('');

        // åˆå§‹ä½ç½®è¨­å®šåœ¨ä¸­é–“é‚£çµ„ (Set 2) çš„é–‹é ­
        currentIndex = realCount; 
        updateCarouselView(false); // åˆå§‹æ¸²æŸ“ä¸éœ€å‹•ç•«
    }

    // æ ¸å¿ƒç‰©ç†å…¬å¼æ›´æ–° View
    function updateCarouselView(withAnimation = true) {
        const track = document.getElementById('mallTrack');
        const container = document.getElementById('carouselContainer');
        const cards = document.querySelectorAll('.mall-card');
        
        if (!track || !container) return;

        // è¨ˆç®—ç½®ä¸­ Offset
        // å…¬å¼ï¼šåç§»é‡ = (å®¹å™¨å¯¬åº¦ / 2) - (å–®å¼µå¡ç‰‡å¯¬åº¦ / 2) - (ç›®å‰ç´¢å¼• * æ­¥é€²è·é›¢)
        const containerCenter = container.offsetWidth / 2;
        const cardCenter = CARD_WIDTH / 2;
        const offset = containerCenter - cardCenter - (currentIndex * STEP);

        // è¨­å®šå‹•ç•«å±¬æ€§
        track.style.transition = withAnimation ? 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)' : 'none';
        track.style.transform = `translateX(${offset}px)`;

        // æ›´æ–° Active æ¨£å¼ (æ¬Šé‡è¦†è“‹)
        cards.forEach((card, idx) => {
            if (idx === currentIndex) {
                card.classList.add('active');
            } else {
                card.classList.remove('active');
            }
        });
    }

    // ç§»å‹•æ§åˆ¶
    // ä¿®æ­£å¾Œçš„ç§»å‹•å‡½å¼ï¼šæ¯æ¬¡ç§»å‹•éƒ½æœƒé‡ç½®è¨ˆæ™‚å™¨
    function moveCarousel(dir) {
        // 1. å¦‚æœæ­£åœ¨å‹•ç•«ä¸­ï¼Œå¿½ç•¥é€™æ¬¡é»æ“Š
        if (isCarouselAnimating) return;

        // 2. [é—œéµä¿®æ­£] ç„¡è«–æ˜¯æ‰‹å‹•æŒ‰é‚„æ˜¯è‡ªå‹•è·‘ï¼Œä¸€æ—¦ç§»å‹•å°±ã€Œé‡ç½®è¨ˆæ™‚å™¨ã€
        // é€™æ¨£å¯ä»¥ç¢ºä¿æŒ‰å®ŒæŒ‰éˆ•å¾Œï¼Œæœƒä¹–ä¹–é‡æ–°å€’æ•¸ 3 ç§’ï¼Œä¸æœƒé¦¬ä¸Šäº‚è·³
        startAutoPlay(); 

        isCarouselAnimating = true;
        currentIndex += dir;
        updateCarouselView(true);
    }

    // ç¬ç§»ç›£è½ (Teleport Logic)
    function handleTransitionEnd() {
        isCarouselAnimating = false;
        
        // å¦‚æœè·‘åˆ° Set 3 (å³å´ç·©è¡å€)ï¼Œç¬ç§»å› Set 2
        if (currentIndex >= realCount * 2) {
            currentIndex = currentIndex - realCount;
            updateCarouselView(false); // é—œé–‰å‹•ç•«ç¬é–“åˆ‡æ›
        }
        // å¦‚æœè·‘åˆ° Set 1 (å·¦å´ç·©è¡å€)ï¼Œç¬ç§»å› Set 2
        else if (currentIndex < realCount) {
            currentIndex = currentIndex + realCount;
            updateCarouselView(false);
        }
    }

    // é»æ“Šäº‹ä»¶ (å·²è¢« CSS pointer-events ä¿è­·ï¼Œé€™è£¡åšäºŒæ¬¡æª¢æŸ¥)
    function handleCardClick(el, name) {
        if (!el.classList.contains('active')) return;
        showFloorPlan(name);
    }

    // è‡ªå‹•è¼ªæ’­ (ç„¡ hover æš«åœ)
    function startAutoPlay() {
        clearInterval(autoPlayTimer);
        autoPlayTimer = setInterval(() => {
            moveCarousel(1);
        }, 3000);
    }

    // ==========================================================================
    // 2. æœå°‹åŠŸèƒ½ (æ’åºèˆ‡æ¬„ä½éœ€æ±‚)
    // ==========================================================================
    async function smartSearch() {
        const city = document.getElementById('citySelect').value;
        const brand = document.getElementById('brandInput').value.trim();
        const resultArea = document.getElementById('resultArea');
        
        resultArea.innerHTML = "<p style='width:100%;text-align:center;color:#666;'>â³ æœå°‹ä¸­...</p>";

        try {
            const apiUrl = `${BASE_URL}/api/smart-search?city=${city}&brand=${encodeURIComponent(brand)}`;
            const res = await fetch(apiUrl);
            const json = await res.json();
            const data = json.data || [];

            resultArea.innerHTML = "";
            if (data.length === 0) {
                resultArea.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:20px;color:#888;'>âŒ æ‰¾ä¸åˆ°ç›¸é—œè³‡æ–™</div>";
                return;
            }

            // è³‡æ–™æ•´ç†
            const mallMap = new Map();
            data.forEach(row => {
                if (!mallMap.has(row.storeName)) {
                    mallMap.set(row.storeName, { ...row, foundBrands: [] });
                }
                if (brand && row.brand_name) {
                    mallMap.get(row.storeName).foundBrands.push(`${row.brand_name} (${row.floor})`);
                }
            });

            // æ’åºï¼šå‘½ä¸­æ•¸é‡å¤š -> å°‘
            const sortedMalls = Array.from(mallMap.values()).sort((a, b) => {
                const countA = new Set(a.foundBrands).size;
                const countB = new Set(b.foundBrands).size;
                return countB - countA;
            });

            sortedMalls.forEach(mall => {
                const phone = mall.phone ? `ğŸ“ ${mall.phone}` : "æš«ç„¡é›»è©±";
                const hours = mall.business_hours ? `ğŸ•’ ${mall.business_hours}` : "ç‡Ÿæ¥­æ™‚é–“æœªæä¾›";
                const floorRange = mall.floor_range ? `æ¨“å±¤ï¼š${mall.floor_range}` : "";
                
                let brandHtml = "";
                let matchBadge = "";
                const uniqueBrands = [...new Set(mall.foundBrands)];

                if (uniqueBrands.length > 0) {
                    matchBadge = `<span style="font-size:0.8rem; color:#E65100; margin-left:10px;">(ç¬¦åˆ ${uniqueBrands.length} æ«ƒ)</span>`;
                    brandHtml = `
                        <div class="match-box">
                            <div class="match-title">ğŸ‰ å‘½ä¸­å“ç‰Œï¼š${matchBadge}</div>
                            <div>${uniqueBrands.map(b => `<span class="brand-tag">${b}</span>`).join('')}</div>
                        </div>
                    `;
                }

                resultArea.innerHTML += `
                    <div class="result-card">
                        <h4>ğŸ„ ${mall.storeName}</h4>
                        <p class="info">ğŸ“ ${mall.address}</p>
                        <p class="info" style="font-size:0.9rem; color:#666;">${phone}</p>
                        <p class="info" style="font-size:0.9rem; color:#666;">${hours}</p>
                        <p class="info" style="color:#B00020; font-weight:bold;">${floorRange}</p>
                        ${brandHtml}
                        <button class="btn-search" style="margin-top:15px; width:100%; font-size:0.9rem;" 
                            onclick="showFloorPlan('${mall.storeName}')">
                            æŸ¥çœ‹å®Œæ•´æ¨“å±¤
                        </button>
                    </div>
                `;
            });

        } catch (e) {
            console.error(e);
            resultArea.innerHTML = `<p style='color:red;'>éŒ¯èª¤ï¼š${e.message}</p>`;
        }
    }

    // ==========================================================================
    // 3. æ¨“å±¤å°è¦½ (GBF æ’åº + æŒä¹…åŒ–æœå°‹)
    // ==========================================================================
    let currentFloorData = {}; 
    let currentMallName = ""; 
    // ç”¨æ–¼è¨˜éŒ„ã€Œå…¨åŸŸã€æœå°‹é—œéµå­—ï¼Œä»¥ä¾¿åˆ‡æ›æ¨“å±¤æ™‚é‡ç¹ªç´…æ¡†
    let persistentSearchKeyword = "";

    async function showFloorPlan(storeName) {
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('floorView').style.display = 'block';
        document.getElementById('floorTitle').innerText = storeName;
        currentMallName = storeName;

        // é‡ç½®æ¨“å±¤æœå°‹è¼¸å…¥ï¼Œä½†å¦‚æœæœ‰å¤–éƒ¨å¸¶å…¥çš„æ„åœ–å¯åœ¨æ­¤æ“´å……
        document.getElementById('floorSearchInput').value = "";
        document.getElementById('floorSearchInput').placeholder = `åœ¨ ${storeName} å…§æœå°‹...`;
        persistentSearchKeyword = ""; 
        checkFloorSearch();
        
        const floorBtnList = document.getElementById('floorBtnList');
        const grid = document.getElementById('brandGrid');
        
        floorBtnList.innerHTML = "<div style='color:#ccc;text-align:center;padding:10px;'>è¼‰å…¥ä¸­...</div>";
        grid.innerHTML = "";

        try {
            const res = await fetch(`${BASE_URL}/api/mall-floors?name=${encodeURIComponent(storeName)}`);
            const json = await res.json();
            
            floorBtnList.innerHTML = "";
            if (!json.success || !json.data) {
                floorBtnList.innerHTML = "<div style='padding:10px; color:white;'>ç„¡è³‡æ–™</div>";
                return;
            }

            const floors = json.data;
            currentFloorData = floors;

            // æ¨“å±¤æ’åº Key
            const floorKeys = Object.keys(floors).sort((a, b) => {
                return getFloorValue(a) - getFloorValue(b);
            });

            floorKeys.forEach(f => {
                const btn = document.createElement('div');
                btn.className = 'floor-btn';
                btn.innerText = f;
                btn.id = `btn-floor-${f}`; 
                btn.onclick = () => selectFloor(f, btn);
                floorBtnList.appendChild(btn);
            });

            // é è¨­é¸å–é‚è¼¯
            if (document.getElementById('btn-floor-1F')) {
                document.getElementById('btn-floor-1F').click();
            } else if (floorKeys.length > 0) {
                document.getElementById(`btn-floor-${floorKeys[0]}`).click();
            }

        } catch (e) {
            console.error(e);
        }
    }

    // æ¨“å±¤åˆ‡æ›
    function selectFloor(floorName, btnElement) {
        document.querySelectorAll('.floor-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        
        document.getElementById('currentFloorLabel').innerText = floorName;

        const grid = document.getElementById('brandGrid');
        grid.innerHTML = "";
        
        const brands = currentFloorData[floorName] || [];
        
        if (brands.length === 0) {
            grid.innerHTML = "<div style='grid-column:1/-1;text-align:center;color:#999;'>æœ¬æ¨“å±¤ç„¡è³‡æ–™</div>";
            return;
        }

        // æ¸²æŸ“å“ç‰Œæ–¹å¡Š
        brands.forEach(brand => {
            const card = document.createElement('div');
            card.className = 'brand-box';
            card.innerText = brand;
            card.dataset.name = brand; 

            // æŒä¹…åŒ–ï¼šæª¢æŸ¥æ˜¯å¦æœ‰æœå°‹é—œéµå­—
            if (persistentSearchKeyword && brand.toLowerCase().includes(persistentSearchKeyword)) {
                card.classList.add('highlight-brand');
            }

            grid.appendChild(card);
        });
    }

    // ä¿®æ­£å¾Œçš„ GBF æ’åºé‚è¼¯
    function getFloorValue(f) {
        f = f.toUpperCase().trim();
        // GBF è¦åœ¨ 1F ä¸‹é¢ (0.1)ï¼Œä½†åˆè¦æ¯” B1 (-1) å¤§ -> è¨­å®šç‚º 0
        // 1F = 1, B1 = -1. GBF = 0
        if (f === 'GBF') return 0; 
        if (f === 'G') return 0;
        
        if (f.startsWith('B')) {
            const num = parseInt(f.replace('B', ''));
            return isNaN(num) ? -100 : -num; 
        }
        if (f.endsWith('F')) {
            const num = parseInt(f.replace('F', ''));
            return isNaN(num) ? 100 : num;
        }
        return 100;
    }

    // æ¨“å±¤å…§æœå°‹èˆ‡æŒä¹…åŒ–
    function checkFloorSearch() {
        const val = document.getElementById('floorSearchInput').value;
        document.getElementById('floorSearchClear').style.display = val ? 'block' : 'none';
        
        // åªæœ‰ç•¶ input ç‚ºç©ºæ™‚æ‰æ¸…ç©º highlight
        if (!val) {
             persistentSearchKeyword = "";
             refreshCurrentFloor();
        }
    }

    function searchInFloor() {
        const keyword = document.getElementById('floorSearchInput').value.trim().toLowerCase();
        if (!keyword) return;

        persistentSearchKeyword = keyword; // å„²å­˜é—œéµå­—
        
        // æ‰¾å‡ºå«æœ‰è©²é—œéµå­—çš„æ¨“å±¤
        let matchedFloors = [];
        for (const [floor, brands] of Object.entries(currentFloorData)) {
            if (brands.some(b => b.toLowerCase().includes(keyword))) {
                matchedFloors.push(floor);
            }
        }

        if (matchedFloors.length > 0) {
            // æ’åºæ‰¾åˆ°çš„æ¨“å±¤
            matchedFloors.sort((a, b) => getFloorValue(a) - getFloorValue(b));
            
            // è·³è½‰åˆ°ç¬¬ä¸€å€‹å‘½ä¸­æ¨“å±¤
            const targetFloor = matchedFloors[0];
            const btn = document.getElementById(`btn-floor-${targetFloor}`);
            if (btn) btn.click(); // click æœƒè§¸ç™¼ selectFloor -> é€²è€Œè§¸ç™¼ highlight
        } else {
            alert(`åœ¨ ${currentMallName} æ‰¾ä¸åˆ°èˆ‡ã€Œ${keyword}ã€ç›¸é—œçš„å“ç‰Œã€‚`);
        }
    }

    function refreshCurrentFloor() {
        const currentFloor = document.getElementById('currentFloorLabel').innerText;
        const currentBtn = document.querySelector('.floor-btn.active');
        if(currentFloor) selectFloor(currentFloor, currentBtn);
    }

    function clearFloorSearch() {
        document.getElementById('floorSearchInput').value = '';
        persistentSearchKeyword = "";
        checkFloorSearch();
    }

    // ä¿®æ­£å¾Œçš„é—œé–‰æ¨“å±¤å‡½å¼
// ä¿®æ­£å¾Œçš„é—œé–‰æ¨“å±¤å‡½å¼ï¼šè§£æ±ºè¼ªæ’­å¡æ­»èˆ‡æŒ‰éˆ•å¤±æ•ˆ
function closeFloorView() {
    const mainView = document.getElementById('mainView');
    const floorView = document.getElementById('floorView');
    
    // 1. åˆ‡æ›ç•«é¢
    floorView.style.display = 'none';
    mainView.style.display = 'block';

    // 2. æ¸…é™¤æ¨“å±¤æœå°‹ç‹€æ…‹
    clearFloorSearch();

    // 3. å»¶é²åŸ·è¡Œä»¥ç¢ºä¿ç•«é¢æ¸²æŸ“å®Œæˆ
    setTimeout(() => {
        // [é—œéµä¿®æ­£] å¼·åˆ¶é‡ç½®å‹•ç•«é–å®šç‹€æ…‹ï¼Œè®“å·¦å³æŒ‰éˆ•å¯ä»¥å†æ¬¡è¢«é»æ“Š
        isCarouselAnimating = false; 

        // é‡æ–°å®šä½è¼ªæ’­åœ–åˆ°æ­£ä¸­é–“ (ç„¡å‹•ç•«æ¨¡å¼)
        updateCarouselView(false);

        // [é—œéµä¿®æ­£] é‡æ–°å•Ÿå‹•è‡ªå‹•è¼ªæ’­è¨ˆæ™‚å™¨
        startAutoPlay();
    }, 50);
}

    // ==========================================================================
    // 4. å…¶ä»–è¼”åŠ©å‡½å¼
    // ==========================================================================
    function checkInput() {
        const val = document.getElementById('brandInput').value;
        document.getElementById('clearBtn').style.display = val ? 'block' : 'none';
    }
    function clearInput() {
        document.getElementById('brandInput').value = '';
        checkInput();
    }
    
    // AI å€å¡Š (ä¿æŒåŸæ¨£)
    function toggleAI() {
        const modal = document.getElementById('aiModal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }
    async function sendAiMsg() {
        const input = document.getElementById('aiInput');
        const body = document.getElementById('aiChatBody');
        const q = input.value.trim();
        if (!q) return;

        body.innerHTML += `<div class="msg msg-user">${q}</div>`;
        input.value = '';
        body.scrollTop = body.scrollHeight;

        const loadId = 'loading-' + Date.now();
        body.innerHTML += `<div id="${loadId}" class="msg msg-ai">ğŸ¤– æ€è€ƒä¸­...</div>`;

        try {
            const res = await fetch(`${BASE_URL}/api/ai-recommend?q=${encodeURIComponent(q)}`);
            const json = await res.json();
            document.getElementById(loadId).remove();
            // âœ… æ–°çš„å¯«æ³• (æ”¯æ´ Markdown ç²—é«”ã€æ¸…å–®èˆ‡æ›è¡Œ)
            body.innerHTML += `<div class="msg msg-ai">${marked.parse(json.reply)}</div>`;
        } catch (e) {
            document.getElementById(loadId).remove();
            body.innerHTML += `<div class="msg msg-ai">é€£ç·šéŒ¯èª¤ã€‚</div>`;
        }
        body.scrollTop = body.scrollHeight;
    }

    // åˆå§‹åŒ–èˆ‡è¦–çª—éŸ¿æ‡‰
    document.addEventListener('DOMContentLoaded', () => {
        initMallCarousel();
    });
    
    window.addEventListener('resize', () => {
        updateCarouselView(false); // è¦–çª—ç¸®æ”¾æ™‚é‡æ–°è¨ˆç®—ç½®ä¸­ï¼Œä½†ä¸æ’­æ”¾å‹•ç•«
    });
</script>
</body>
</html>