<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•å°Šæ¦®å“ç‰ŒæŸ¥è©¢ç³»çµ± - AI æ™ºèƒ½æœå°‹ç‰ˆ</title>
    <style>
        /* ================= åŸºç¤æ¨£å¼ ================= */
        body { font-family: 'Times New Roman', 'Microsoft JhengHei', serif; background-color: #fff0f0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 40px 0; }
        
        .container { background: white; padding: 2.5rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(176, 0, 32, 0.1); width: 90%; max-width: 1000px; position: relative; border-top: 8px solid #B00020; margin-bottom: 50px; }
        
        h2 { text-align: center; color: #B00020; font-family: 'Georgia', serif; font-size: 2.2rem; margin-bottom: 2rem; border-bottom: 2px solid #FFD700; padding-bottom: 15px; }
        h3 { color: #B00020; margin-top: 0; font-size: 1.4rem; margin-bottom: 15px; }

        /* ================= è¼ªæ’­æ¨£å¼ ================= */
        .carousel-section { margin-bottom: 3rem; overflow: hidden; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .carousel-container { display: flex; transition: transform 0.8s ease-in-out; width: 100%; }
        .carousel-card { min-width: 100%; height: 280px; flex-shrink: 0; background-size: cover; background-position: center; color: white; padding: 40px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: flex-end; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8); }
        
        .card-bg-1 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1544979590-37e26a6cd737?auto=format&fit=crop&w=1000&q=80'); }
        .card-bg-2 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1512389142860-9c449e58a543?auto=format&fit=crop&w=1000&q=80'); }
        .card-bg-3 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1513297887119-d46091b24bfa?auto=format&fit=crop&w=1000&q=80'); }
        .card-bg-4 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1576694040870-15938006b023?auto=format&fit=crop&w=1000&q=80'); }

        /* ================= æœå°‹æ¡†æ¨£å¼ ================= */
        .search-box { background: #fffbf0; padding: 25px; border-radius: 15px; margin-bottom: 30px; border: 1px solid #FFD700; }
        .search-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; position: relative; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; outline: none; }
        input:focus, select:focus { border-color: #B00020; }

        .btn-group { display: flex; gap: 10px; }
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
        .btn-search { background-color: #B00020; color: white; }
        .btn-search:hover { background-color: #8C0018; transform: translateY(-2px); }
        .btn-ai { background-color: #FFD700; color: #B00020; }
        .btn-ai:hover { background-color: #f7c600; transform: translateY(-2px); }

        .clear-btn { position: absolute; right: 12px; top: 40px; background: #ddd; color: white; width: 22px; height: 22px; border-radius: 50%; text-align: center; line-height: 22px; cursor: pointer; display: none; font-size: 14px; }
        .clear-btn:hover { background: #B00020; }

        /* ================= æœå°‹çµæœå¡ç‰‡ ================= */
        .card-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-top: 25px; }
        
        .result-card {
            background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 6px solid #B00020; padding: 20px; transition: 0.3s; position: relative; overflow: hidden;
        }
        .result-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .result-card h4 { margin: 0 0 10px 0; color: #B00020; font-size: 1.3rem; display: flex; align-items: center; gap: 8px; }
        .result-card .info { color: #555; font-size: 0.95rem; margin: 5px 0; line-height: 1.5; }
        .result-card .match-box { background: #fff5f5; padding: 10px; border-radius: 8px; margin-top: 15px; border: 1px dashed #B00020; }
        .result-card .match-title { font-weight: bold; color: #B00020; font-size: 0.9rem; margin-bottom: 5px; }
        .brand-tag { display: inline-block; background: #FFD700; color: #B00020; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; margin-right: 5px; margin-bottom: 5px; }

        /* ================= AI è¦–çª— ================= */
        #aiModal { display: none; position: fixed; bottom: 20px; right: 20px; width: 360px; height: 520px; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 3000; flex-direction: column; border: 3px solid #FFD700; overflow: hidden; }
        .ai-header { background: #B00020; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .ai-body { flex: 1; padding: 15px; overflow-y: auto; background: #fffcfc; display: flex; flex-direction: column; gap: 12px; }
        .ai-footer { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px; background: white; }
        .msg { padding: 10px 14px; border-radius: 15px; max-width: 85%; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
        .msg-ai { background: #f0f0f0; color: #333; align-self: flex-start; }
        .msg-user { background: #B00020; color: white; align-self: flex-end; }

        /* =========================================
           âœ¨ [æœ€çµ‚ä¿®æ­£ç‰ˆ] æ¨“å±¤å°è¦½æ¨£å¼
           ========================================= */
        #floorView {
            display: none; 
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%;
            height: 100vh;
            background: #fffbf0;
            z-index: 2000;
        }

        .floor-layout {
            display: flex;
            width: 100%;
            height: 100%;
        }

        /* å·¦å´å®¹å™¨ï¼šå›ºå®šå¯¬åº¦ */
        .floor-sidebar-container {
            width: 220px;
            background: #2c3e50;
            border-right: 4px solid #B00020;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 2010;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #444;
            background: #2c3e50;
        }

        .close-floor-btn {
            width: 100%;
            background: #c0392b;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .close-floor-btn:hover { background: #e74c3c; }

        /* ä¿®æ­£æ¨“å±¤åˆ—è¡¨ï¼šç¢ºä¿æ²å‹•æ­£å¸¸ï¼Œä¸è¢«åƒæ‰ */
        .floor-btn-list {
            flex: 1;
            overflow-y: auto; 
            display: flex;
            flex-direction: column-reverse; /* ä½æ¨“å±¤åœ¨ä¸‹ */
            padding-bottom: 50px; /* ç•™ç™½é˜²æ­¢æœ€åº•æŒ‰éˆ•è¢«æˆªæ–· */
        }

        .floor-btn-list::-webkit-scrollbar { width: 6px; }
        .floor-btn-list::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        .floor-btn {
            padding: 18px 10px; 
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Georgia', serif;
            font-size: 1.2rem;
            border-bottom: 1px solid #444;
            transition: all 0.2s;
            color: #ccc;
        }

        .floor-btn:hover { background: #444; color: white; }

        .floor-btn.active {
            background: #B00020; 
            color: #FFD700;      
            font-size: 1.5rem; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.4);
        }

        /* å³å´ï¼šå…§å®¹å€ */
        .floor-content {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .floor-header-sticky {
            position: sticky;
            top: 0;
            background: #fffbf0;
            z-index: 2005;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }

        /* æ¨“å±¤å…§æœå°‹æ¡† + æŸ¥è©¢æŒ‰éˆ• */
        .floor-search-container {
            display: flex;
            align-items: center;
            position: relative;
            width: 360px;
            gap: 10px;
        }

        .floor-search-input-wrapper {
            position: relative;
            flex: 1;
        }

        .floor-search-input {
            width: 100%;
            padding: 12px 40px 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.2s;
            background: white;
            box-sizing: border-box;
        }
        
        .floor-search-input:focus {
            border-color: #B00020;
            box-shadow: 0 0 8px rgba(176, 0, 32, 0.1);
        }

        .floor-search-clear {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 16px;
            display: none; 
            font-weight: bold;
            z-index: 5;
        }
        .floor-search-clear:hover { color: #B00020; }

        .btn-floor-query {
            background-color: transparent;
            color: #2c3e50;                /* èˆ‡å·¦å´é¸å–®ä¸€è‡´çš„æ·±çŸ³é’è‰² */
            border: 2px solid #ddd;        /* èˆ‡æœå°‹æ¡†ä¸€è‡´çš„é‚Šæ¡†ç²—ç´°èˆ‡é¡è‰² */
            border-radius: 50%;            /* æ”¹ç‚ºåœ“å½¢ï¼Œè¦–è¦ºä¸Šèˆ‡åœ“è§’æœå°‹æ¡†æœ€å¥‘åˆ */
            width: 48px;                   /* ç¨å¾®æ”¾å¤§ä¸€é»ï¼Œèˆ‡æœå°‹æ¡†é«˜åº¦æ›´å”èª¿ */
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .btn-floor-query:hover { 
            background-color: #f4f4f4;
            border-color: #2c3e50;        /* ç§»ä¸Šå»æ™‚é‚Šæ¡†è®Šæ·±ï¼Œå¢åŠ äº’å‹•æ„Ÿ */
            color: #2c3e50;
            transform: scale(1.05);
        }

        .btn-floor-query:active {
            transform: scale(0.95);        /* é»æ“Šæ™‚æœ‰å…§ç¸®å£“åŠ›æ„Ÿ */
        }

        /* å“ç‰Œæ–¹å¡Šç‰† */
        .floor-grid-container {
            padding: 30px;
        }

        .brand-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 15px;
        }

        .brand-box {
            aspect-ratio: 1 / 1; 
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 8px; 
            font-size: 0.9rem; 
            font-weight: 500;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
            word-break: break-word;
            cursor: default;
        }

        /* é«˜äº®æ¨£å¼ */
        .brand-box.highlight-brand {
            background-color: #fff3e0;
            border: 3px solid #e65100;
            color: #e65100;
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(230, 81, 0, 0.4);
            font-weight: bold;
            z-index: 10;
        }

        @media (max-width: 900px) {
            .floor-sidebar-container { width: 100px; } 
            .brand-grid { grid-template-columns: repeat(3, 1fr); }
            .floor-header-sticky { flex-direction: column; align-items: flex-start; gap: 10px; padding: 15px; }
            .floor-search-container { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container" id="mainView">
    <h2>âœ¨ è–èª•å°Šæ¦®å“ç‰ŒæŸ¥è©¢ç³»çµ±</h2>

    <div class="carousel-section">
        <div id="autoCarousel" class="carousel-container">
            <div class="carousel-card card-bg-1"><h4>å°åŒ—ä¿¡ç¾©æ–°å¤©åœ° A11</h4><p>ğŸ è–èª•äº®é»ï¼šå…¨å°æœ€é«˜è–èª•æ¨¹ï¼Œå¿…æ‹æ™¯é»ï¼</p></div>
            <div class="carousel-card card-bg-2"><h4>æ¡ƒåœ’çµ±é ˜ç™¾è²¨</h4><p>ğŸ›ï¸ å„ªæƒ ï¼šå¹´æœ«æ„Ÿè¬ç¥­ï¼Œå…¨é¤¨æ»¿åƒé€ç™¾ã€‚</p></div>
            <div class="carousel-card card-bg-3"><h4>æ¿æ©‹å¤§é ç™¾</h4><p>ğŸ„ ç‰¹è‰²ï¼šå¨å°¼æ–¯å»£å ´è–èª•å¸‚é›†é–‹è·‘ã€‚</p></div>
            <div class="carousel-card card-bg-4"><h4>æ–°å…‰ä¸‰è¶Š é‘½çŸ³å¡”</h4><p>ğŸ¥‚ æ¨è–¦ï¼šé ‚ç´šé¦™æ°›èˆ‡ç±³å…¶æ—é¤å»³é€²é§ã€‚</p></div>
        </div>
    </div>

    <div class="search-box">
        <h3>ğŸ” æ‰¾å“ç‰Œ / æ‰¾ç™¾è²¨</h3>
        <div class="search-row">
            <div class="input-group" style="flex: 0.4;">
                <label>é¸æ“‡åœ°å€</label>
                <select id="citySelect">
                    <option value="All">å…¨å°æœå°‹</option>
                    <option value="Taipei">è‡ºåŒ—</option>
                    <option value="NewTaipei">æ–°åŒ—</option>
                    <option value="Taoyuan">æ¡ƒåœ’</option>
                </select>
            </div>
            <div class="input-group" style="flex: 1.2;">
                <label>è¼¸å…¥å“ç‰Œ</label>
                <input type="text" id="brandInput" placeholder="è¼¸å…¥å“ç‰Œåç¨±..." oninput="checkInput()" onkeypress="if(event.key==='Enter') smartSearch()">
                <div id="clearBtn" class="clear-btn" onclick="clearInput()">âœ•</div>
            </div>
            <div class="btn-group">
                <button class="btn-search" onclick="smartSearch()">ç«‹å³æŸ¥è©¢</button>
                <button class="btn-ai" onclick="toggleAI()">ğŸª„ AI è©¢å•</button>
            </div>
        </div>
        
        <div id="resultArea" class="card-container"></div>
    </div>
</div>

<div id="floorView">
    <div class="floor-layout">
        <div class="floor-sidebar-container">
            <div class="sidebar-header">
                <button class="close-floor-btn" onclick="closeFloorView()">â† é€€å‡ºå°è¦½</button>
            </div>
            <div class="floor-btn-list" id="floorBtnList">
                </div>
        </div>

        <div class="floor-content">
            <div class="floor-header-sticky">
                <div>
                    <h2 id="floorTitle" style="margin:0; border:none; text-align:left; font-size:1.7rem;">ç™¾è²¨åç¨±</h2>
                    <span style="color:#666;">ç›®å‰æ¨“å±¤ï¼š</span>
                    <span id="currentFloorLabel" style="color:#B00020; font-weight:bold; font-size:1.5rem;">1F</span>
                </div>
                
                <div class="floor-search-container">
                    <div class="floor-search-input-wrapper">
                        <input type="text" id="floorSearchInput" class="floor-search-input" placeholder="åœ¨ç™¾è²¨å…§æœå°‹å“ç‰Œ..." oninput="checkFloorSearch()" onkeypress="if(event.key==='Enter') searchInFloor()">
                        <span id="floorSearchClear" class="floor-search-clear" onclick="clearFloorSearch()">âœ•</span>
                    </div>
                    <button class="btn-floor-query" onclick="searchInFloor()">ğŸ”</button>
                </div>
            </div>
            
            <div class="floor-grid-container">
                <div id="brandGrid" class="brand-grid"></div>
            </div>
        </div>
    </div>
</div>

<div id="aiModal">
    <div class="ai-header">
        <span>ğŸ¤– è–èª•è³¼ç‰© AI é¡§å•</span>
        <span style="cursor:pointer; font-size:1.2rem;" onclick="toggleAI()">âœ•</span>
    </div>
    <div class="ai-body" id="aiChatBody">
        <div class="msg msg-ai">æ‚¨å¥½ï¼æˆ‘æ˜¯è–èª• AI é¡§å• ğŸ…<br>è³‡æ–™åº«å·²æ›´æ–°ï¼<br>æ‚¨å¯ä»¥å•æˆ‘ï¼šã€Œæ¡ƒåœ’å“ªè£¡æœ‰ Nikeï¼Ÿã€æˆ–ã€Œä¿¡ç¾© A8 æœ‰ä»€éº¼å¥½åƒçš„ï¼Ÿã€</div>
    </div>
    <div class="ai-footer">
        <input type="text" id="aiInput" placeholder="è¼¸å…¥å•é¡Œ..." onkeypress="if(event.key==='Enter') sendAiMsg()">
        <button class="btn-search" style="padding: 8px 15px;" onclick="sendAiMsg()">é€å‡º</button>
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:3000';

    // 1. æœå°‹é‚è¼¯
    async function smartSearch() {
        const city = document.getElementById('citySelect').value;
        const brand = document.getElementById('brandInput').value.trim();
        const resultArea = document.getElementById('resultArea');
        
        resultArea.innerHTML = "<p style='width:100%;text-align:center;color:#666;'>â³ æ­£åœ¨æœå°‹è³‡æ–™åº«...</p>";

        try {
            const apiUrl = `${BASE_URL}/api/smart-search?city=${city}&brand=${encodeURIComponent(brand)}`;
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error("API Error");
            
            const json = await res.json();
            const data = json.data || [];

            resultArea.innerHTML = "";
            if (data.length === 0) {
                resultArea.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:20px;color:#888;'>âŒ æ‰¾ä¸åˆ°ç›¸é—œè³‡æ–™</div>";
                return;
            }

            const mallMap = new Map();
            data.forEach(row => {
                if (!mallMap.has(row.storeName)) {
                    mallMap.set(row.storeName, { ...row, foundBrands: [] });
                }
                if (brand && row.brand_name) {
                    mallMap.get(row.storeName).foundBrands.push(`${row.brand_name} (${row.floor})`);
                }
            });

            const sortedMalls = Array.from(mallMap.values()).sort((a, b) => {
                const countA = new Set(a.foundBrands).size;
                const countB = new Set(b.foundBrands).size;
                return countB - countA;
            });

            sortedMalls.forEach(mall => {
                const phone = mall.phone ? `ğŸ“ ${mall.phone}` : "";
                const hours = mall.business_hours ? `ğŸ•’ ${mall.business_hours}` : "";
                const floorRange = mall.floor_range ? `æ¨“å±¤ï¼š${mall.floor_range}` : "";
                
                let brandHtml = "";
                let matchBadge = ""; 
                if (mall.foundBrands.length > 0) {
                    const uniqueBrands = [...new Set(mall.foundBrands)];
                    if (brand.includes(" ") || brand.includes(",")) {
                        matchBadge = `<span style="font-size:0.8rem; color:#E65100; margin-left:10px;">(ç¬¦åˆ ${uniqueBrands.length} å€‹)</span>`;
                    }
                    brandHtml = `
                        <div class="match-box">
                            <div class="match-title">ğŸ‰ æ‰¾åˆ°ä»¥ä¸‹å“ç‰Œï¼š${matchBadge}</div>
                            <div>${uniqueBrands.map(b => `<span class="brand-tag">${b}</span>`).join('')}</div>
                        </div>
                    `;
                }

                resultArea.innerHTML += `
                    <div class="result-card">
                        <h4>ğŸ„ ${mall.storeName}</h4>
                        <p class="info">ğŸ“ ${mall.address}</p>
                        <p class="info" style="font-size:0.9rem; color:#666;">${phone} | ${hours}</p>
                        <p class="info" style="color:#B00020; font-weight:bold;">${floorRange}</p>
                        ${brandHtml}
                        <button class="btn-search" style="margin-top:15px; width:100%; font-size:0.9rem;" 
                            onclick="showFloorPlan('${mall.storeName}')">
                            æŸ¥çœ‹å®Œæ•´æ¨“å±¤
                        </button>
                    </div>
                `;
            });

        } catch (e) {
            console.error(e);
            resultArea.innerHTML = `<p style='color:red;'>éŒ¯èª¤ï¼š${e.message}</p>`;
        }
    }

    // 2. æ¨“å±¤å°è¦½é‚è¼¯
    let currentFloorData = {}; 
    let currentMallName = ""; 

    async function showFloorPlan(storeName) {
        document.getElementById('mainView').style.display = 'none';
        document.getElementById('floorView').style.display = 'block';
        document.getElementById('floorTitle').innerText = storeName;
        currentMallName = storeName;

        document.getElementById('floorSearchInput').value = "";
        document.getElementById('floorSearchInput').placeholder = `åœ¨ ${storeName} å…§æœå°‹...`;
        checkFloorSearch();
        
        const floorBtnList = document.getElementById('floorBtnList');
        const grid = document.getElementById('brandGrid');
        
        floorBtnList.innerHTML = "<div style='color:#ccc;text-align:center;padding:10px;'>...</div>";
        grid.innerHTML = "";

        try {
            const res = await fetch(`${BASE_URL}/api/mall-floors?name=${encodeURIComponent(storeName)}`);
            const json = await res.json();
            
            floorBtnList.innerHTML = "";
            
            if (!json.success || !json.data) {
                floorBtnList.innerHTML = "<div style='padding:10px; color:white;'>ç„¡è³‡æ–™</div>";
                return;
            }

            const floors = json.data;
            currentFloorData = floors;

            // æ’åºæ¨“å±¤
            const floorKeys = Object.keys(floors).sort((a, b) => {
                return getFloorValue(a) - getFloorValue(b);
            });

            floorKeys.forEach(f => {
                const btn = document.createElement('div');
                btn.className = 'floor-btn';
                btn.innerText = f;
                btn.id = `btn-floor-${f}`; 
                btn.onclick = () => selectFloor(f, btn);
                floorBtnList.appendChild(btn);
            });

            // é è¨­é»é¸ï¼šå„ªå…ˆæ‰¾ 1Fï¼Œæ²’æœ‰çš„è©±é»æœ€ä½æ¨“å±¤
            if (document.getElementById('btn-floor-1F')) {
                document.getElementById('btn-floor-1F').click();
            } else if (floorKeys.length > 0) {
                document.getElementById(`btn-floor-${floorKeys[0]}`).click();
            }

        } catch (e) {
            console.error(e);
            floorBtnList.innerHTML = "Err";
        }
    }

    // 3. æ¸²æŸ“æ¨“å±¤ (æŒä¹…åŒ–æ¨™è¨˜é‚è¼¯)
    function selectFloor(floorName, btnElement) {
        document.querySelectorAll('.floor-btn').forEach(b => b.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        
        document.getElementById('currentFloorLabel').innerText = floorName;

        const grid = document.getElementById('brandGrid');
        grid.innerHTML = "";
        
        const brands = currentFloorData[floorName] || [];
        
        if (brands.length === 0) {
            grid.innerHTML = "<div style='grid-column:1/-1;text-align:center;color:#999;'>æœ¬æ¨“å±¤ç„¡è³‡æ–™</div>";
            return;
        }

        const keyword = document.getElementById('floorSearchInput').value.trim().toLowerCase();

        brands.forEach(brand => {
            const card = document.createElement('div');
            card.className = 'brand-box';
            card.innerText = brand;
            card.dataset.name = brand; 

            // æ¨™è¨˜æœå°‹å‘½ä¸­
            if (keyword && brand.toLowerCase().includes(keyword)) {
                card.classList.add('highlight-brand');
            }

            grid.appendChild(card);
        });
    }

    // 4. æ¨“å±¤å…§æœå°‹
    function checkFloorSearch() {
        const val = document.getElementById('floorSearchInput').value;
        const btn = document.getElementById('floorSearchClear');
        btn.style.display = val ? 'block' : 'none';
        
        if (!val) {
             const currentFloor = document.getElementById('currentFloorLabel').innerText;
             const currentBtn = document.querySelector('.floor-btn.active');
             if(currentFloor) selectFloor(currentFloor, currentBtn);
        }
    }

    function clearFloorSearch() {
        document.getElementById('floorSearchInput').value = '';
        checkFloorSearch();
        const currentFloor = document.getElementById('currentFloorLabel').innerText;
        const currentBtn = document.querySelector('.floor-btn.active');
        if(currentFloor) selectFloor(currentFloor, currentBtn);
    }

    function searchInFloor() {
        const keyword = document.getElementById('floorSearchInput').value.trim().toLowerCase();
        if (!keyword) return;

        let matchedFloors = [];
        for (const [floor, brands] of Object.entries(currentFloorData)) {
            if (brands.some(b => b.toLowerCase().includes(keyword))) {
                matchedFloors.push(floor);
            }
        }

        if (matchedFloors.length > 0) {
            // è·³è½‰è‡³ç¬¦åˆæ¢ä»¶ä¸­çš„ã€Œæœ€ä½æ¨“å±¤ã€
            matchedFloors.sort((a, b) => getFloorValue(a) - getFloorValue(b));
            const targetFloor = matchedFloors[0];

            const btn = document.getElementById(`btn-floor-${targetFloor}`);
            if (btn) btn.click();
        } else {
            alert(`åœ¨ ${currentMallName} æ‰¾ä¸åˆ°èˆ‡ã€Œ${keyword}ã€ç›¸é—œçš„å“ç‰Œã€‚`);
        }
    }

    // 5. æ’åºé‚è¼¯ä¿®æ­£ (è™•ç†ç‰¹æ®Šæ¨“å±¤å¦‚ GBF)
    function getFloorValue(f) {
        f = f.toUpperCase().trim();
        // å¤§æ±Ÿç‰¹æ®Šæ¨“å±¤ï¼šGBF (ç­‰åŒ B1)
        if (f === 'GBF') return -1;
        // åœ°ä¸‹å±¤ï¼šB1 -> -1, B2 -> -2
        if (f.startsWith('B')) {
            const num = parseInt(f.replace('B', ''));
            return isNaN(num) ? -1 : -num; 
        }
        // åœ°ä¸Šå±¤ï¼š1F -> 1, 2F -> 2
        if (f.endsWith('F')) {
            const num = parseInt(f.replace('F', ''));
            return isNaN(num) ? 100 : num;
        }
        // å…¶ä»–ï¼šG, M, UG ç­‰ä¾åºæ’åœ¨ä¸­é–“
        if (f === 'G') return 0;
        if (f === 'M' || f === 'UG') return 0.5;
        return 100;
    }

    function closeFloorView() {
        document.getElementById('mainView').style.display = 'block';
        document.getElementById('floorView').style.display = 'none';
        clearFloorSearch();
    }

    // AI åŠŸèƒ½
    async function sendAiMsg() {
        const input = document.getElementById('aiInput');
        const body = document.getElementById('aiChatBody');
        const q = input.value.trim();
        if (!q) return;

        body.innerHTML += `<div class="msg msg-user">${q}</div>`;
        input.value = '';
        body.scrollTop = body.scrollHeight;

        const loadId = 'loading-' + Date.now();
        body.innerHTML += `<div id="${loadId}" class="msg msg-ai">ğŸ¤– æ€è€ƒä¸­...</div>`;

        try {
            const res = await fetch(`${BASE_URL}/api/ai-recommend?q=${encodeURIComponent(q)}`);
            const json = await res.json();
            document.getElementById(loadId).remove();
            body.innerHTML += `<div class="msg msg-ai">${json.reply.replace(/\n/g, '<br>')}</div>`;
        } catch (e) {
            document.getElementById(loadId).remove();
            body.innerHTML += `<div class="msg msg-ai">é€£ç·šéŒ¯èª¤ã€‚</div>`;
        }
        body.scrollTop = body.scrollHeight;
    }

    let cIdx = 0;
    if(document.getElementById('autoCarousel')) {
        setInterval(() => {
            cIdx = (cIdx + 1) % 4;
            document.getElementById('autoCarousel').style.transform = `translateX(-${cIdx * 100}%)`;
        }, 3500);
    }
    function checkInput() {
        const val = document.getElementById('brandInput').value;
        const btn = document.getElementById('clearBtn');
        if(btn) btn.style.display = val ? 'block' : 'none';
    }
    function clearInput() {
        document.getElementById('brandInput').value = '';
        checkInput();
    }
    function toggleAI() {
        const modal = document.getElementById('aiModal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }
</script>
</body>
</html>