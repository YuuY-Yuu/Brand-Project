<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•å°Šæ¦®å“ç‰ŒæŸ¥è©¢ç³»çµ± - æ™ºèƒ½æ­¸ç´ç‰ˆ</title>
    <style>
        /* ======================================= */
        /* åŸºç¤æ¨£å¼ (è–èª•é…è‰²: æ·±ç´… & é‡‘è‰²) */
        /* ======================================= */
        body {
            font-family: 'Times New Roman', 'Microsoft JhengHei', serif;
            background-color: #f8f8f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 40px 0;
        }
        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 1000px; 
        }
        h2 { 
            text-align: center; 
            color: #B00020;
            font-family: 'Georgia', serif;
            font-size: 2.2rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 15px;
        }
        h3 { 
            color: #B00020; 
            margin-top: 0; 
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        /* ======================================= */
        /* è¼ªæ’­/è·‘é¦¬ç‡ˆæ¨£å¼ (è‡ªå‹•æ’­æ”¾) */
        /* ======================================= */
        .carousel-section {
            margin-bottom: 3rem;
            overflow: hidden; 
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .carousel-container {
            display: flex;
            transition: transform 0.8s ease-in-out;
            width: 100%;
        }
        .carousel-card {
            min-width: 100%;
            height: 280px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            color: white;
            padding: 40px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
        }
        .carousel-card h4 { margin: 0; font-size: 2.2rem; color: #FFD700; margin-bottom: 10px; }
        .carousel-card p { font-size: 1.1rem; margin: 3px 0; opacity: 0.9; }

        .card-bg-1 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://picsum.photos/1000/400?christmas'); }
        .card-bg-2 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://picsum.photos/1000/400?tree'); }
        .card-bg-3 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://picsum.photos/1000/400?gift'); }
        .card-bg-4 { background-image: linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.6)), url('https://picsum.photos/1000/400?lights'); }

        /* ======================================= */
        /* æ©«å‘æœå°‹åˆ— */
        /* ======================================= */
        .search-box { 
            background: #fff5f5;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .search-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .input-group { flex: 1; min-width: 200px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        
        input, select {
            width: 100%; 
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            padding: 12px 30px;
            background-color: #B00020;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            transition: all 0.3s;
            height: 46px;
        }
        button:hover { 
            background-color: #8C0018;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(176, 0, 32, 0.3);
        }

        /* ======================================= */
        /* çµæœå¡ç‰‡æ¨£å¼ */
        /* ======================================= */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px; 
            margin-top: 25px;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 6px solid #FFD700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            transition: 0.3s;
            display: flex;
            flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); }
        .card h4 { margin: 0 0 10px 0; color: #B00020; font-size: 1.25rem; }
        .card p { margin: 6px 0; color: #555; font-size: 1rem; }
        
        /* å“ç‰Œå°æ¨™ç±¤æ¨£å¼ */
        .brand-badge {
            display: inline-block;
            background-color: #B00020;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-right: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="container">
    <h2>âœ¨ å“ç‰Œé–€å¸‚ç²¾é¸æŸ¥è©¢</h2>

    <div class="carousel-section">
        <div id="autoCarousel" class="carousel-container">
            <div class="carousel-card card-bg-1">
                <h4>é ç™¾ä¿¡ç¾© A13 | è–èª•å¥‡å¹»ä¹‹æ—…</h4>
                <p>ğŸ å„ªæƒ ï¼šé ‚ç´šç²¾å“é™æ™‚æŠ˜æ‰£ï¼Œæ¶ˆè²»æ»¿é¡è´ˆé€è–èª•ç¦®ç›’ï¼</p>
            </div>
            <div class="carousel-card card-bg-2">
                <h4>æ–°å…‰ä¸‰è¶Š é‘½çŸ³å¡” | ç’€ç’¨æ˜Ÿå…‰ç››å®´</h4>
                <p>ğŸ›ï¸ ç‰¹è‰²ï¼šå…¨å°ç¨å®¶è–èª•æ¨¹é€ æ™¯ï¼Œæ‰“å¡é€é£²å“å…Œæ›åˆ¸ï¼</p>
            </div>
            <div class="carousel-card card-bg-3">
                <h4>SOGO å¿ å­é¤¨ | è€¶èª•æš–å¿ƒç»ç¦®</h4>
                <p>ğŸ„ æ¨è–¦ï¼šå¡å‹ç¨äº«ï¼Œç‰¹å®šå“ç‰Œæ¶ˆè²»äº« 9 æŠ˜å„ªæƒ ï¼</p>
            </div>
            <div class="carousel-card card-bg-4">
                <h4>å¾®é¢¨å—å±± | å¥¢è¯è·¨å¹´æ´¾å°</h4>
                <p>ğŸ¥‚ æ¨è–¦ï¼šé ‚æ¨“é…’å§è·¨å¹´æ´»å‹•å¥—ç¥¨é–‹è³£ä¸­ï¼</p>
            </div>
        </div>
    </div>

    <div class="search-box">
        <h3>ğŸ” é–€å¸‚æœå°‹</h3>
        <p style="font-size: 0.8rem; color: #888;">* æ”¯æ´åŒæ™‚æœå°‹å¤šå€‹å“ç‰Œï¼ˆå¦‚ï¼šNike Adidasï¼‰</p>
        <div class="search-row">
            <div class="input-group">
                <label>è«‹é¸æ“‡åŸå¸‚ </label>
                <select id="brandCitySelect">
                    <option value="">-- å…¨éƒ¨ç¸£å¸‚ --</option>
                    <option value="Taipei">è‡ºåŒ—</option>
                    <option value="NewTaipei">æ–°åŒ—</option>
                    <option value="Keelung">åŸºéš†</option>
                    <option value="Taoyuan">æ¡ƒåœ’</option>
                    <option value="Hsinchu">æ–°ç«¹</option>
                </select>
            </div>
            <div class="input-group">
                <label>è«‹è¼¸å…¥å“ç‰Œåç¨± </label>
                <input type="text" id="brandCityInput" placeholder="ä¾‹å¦‚: Nike, Adidas">
            </div>
            <button onclick="smartSearch()">ç«‹å³æŸ¥è©¢</button>
        </div>
        <div id="brandCityResult" class="card-container"></div>
    </div>
</div>

<script>
    const BASE_URL = 'http://localhost:3000';

    async function smartSearch() {
        const fullInput = document.getElementById('brandCityInput').value.trim();
        const cityValue = document.getElementById('brandCitySelect').value;
        const cityText = document.getElementById('brandCitySelect').options[document.getElementById('brandCitySelect').selectedIndex].text;
        const resultDiv = document.getElementById('brandCityResult');

        if (!fullInput && !cityValue) {
            alert("è«‹è¼¸å…¥å“ç‰Œåç¨±æˆ–é¸æ“‡åŸå¸‚å–”ï¼");
            return;
        }

        resultDiv.innerHTML = "ğŸ’ æ­£åœ¨ç‚ºæ‚¨æ•´ç†ç²¾é¸é–€å¸‚...";

        // åˆ‡å‰²å“ç‰Œå­—ä¸²
        const brands = fullInput ? fullInput.split(/[\s,ï¼Œã€]+/) : [];
        
        // æ ¸å¿ƒæ­¸ç´ç‰©ä»¶ï¼šä»¥ã€Œé–€å¸‚åç¨±ã€ç‚º Key
        let storeMap = {};

        // å¦‚æœåªé¸åŸå¸‚æ²’å¡«å“ç‰Œï¼Œå“ç‰Œé™£åˆ—è£œä¸€å€‹ null è®“è¿´åœˆè·‘ä¸€æ¬¡
        const searchLoop = brands.length > 0 ? brands : [null];

        for (const brand of searchLoop) {
            let apiUrl = '';
            if (brand && cityValue) {
                apiUrl = `${BASE_URL}/api/search-brand-in-city?city=${cityValue}&brand=${brand}`;
            } else if (brand) {
                apiUrl = `${BASE_URL}/api/brand-location?name=${brand}`;
            } else {
                apiUrl = `${BASE_URL}/api/store-by-city?city=${cityValue}`;
            }

            try {
                const res = await fetch(apiUrl);
                const data = await res.json();

                // è‹¥å¾Œç«¯å¤±æ•—æˆ–ç„¡è³‡æ–™ï¼Œä½¿ç”¨æ¨¡æ“¬é‚è¼¯æ­¸ç´
                if (data.success === false || !data || data.length === 0) {
                    processDataToMap(getMockData(brand, cityValue ? cityText : "å…¨å°"), brand, storeMap);
                } else {
                    processDataToMap(data, brand, storeMap);
                }
            } catch (e) {
                processDataToMap(getMockData(brand, cityValue ? cityText : "å…¨å°"), brand, storeMap);
            }
        }

        // æ¸²æŸ“æœ€çµ‚æ­¸ç´å¾Œçš„å¡ç‰‡
        renderFinalCards(storeMap, resultDiv);
    }

    // æ­¸ç´å·¥å…·ï¼šå°‡å„å“ç‰ŒæŸ¥è©¢çµæœåˆä½µåˆ° storeMap
    function processDataToMap(data, brand, map) {
        data.forEach(item => {
            const sName = item.name || item.storeName;
            if (!map[sName]) {
                map[sName] = {
                    address: item.address,
                    phone: item.phone,
                    brands: new Set()
                };
            }
            if (brand) map[sName].brands.add(brand);
        });
    }

    // æ¸²æŸ“å‡½å¼ï¼šä¸€å¼µå¡ç‰‡é¡¯ç¤ºè©²é–€å¸‚æ‰€æœ‰å“ç‰Œæ¨™ç±¤
    function renderFinalCards(storeMap, container) {
        container.innerHTML = '';
        const storeNames = Object.keys(storeMap);

        if (storeNames.length === 0) {
            container.innerHTML = '<p style="width:100%;">æ‰¾ä¸åˆ°ç›¸é—œé–€å¸‚ã€‚</p>';
            return;
        }

        storeNames.forEach(name => {
            const store = storeMap[name];
            // å»ºç«‹å“ç‰Œæ¨™ç±¤ HTML
            const badgeHtml = Array.from(store.brands)
                .map(b => `<span class="brand-badge">${b}</span>`)
                .join('');

            container.innerHTML += `
                <div class="card">
                    <h4>ğŸ„ ${name}</h4>
                    <div class="brand-tags">${badgeHtml}</div>
                    <p>ğŸ“ åœ°å€ï¼š${store.address}</p>
                    <p>ğŸ“ é›»è©±ï¼š${store.phone}</p>
                </div>
            `;
        });
    }

    // ç”Ÿæˆæ¨¡æ“¬è³‡æ–™ï¼ˆä¸åŒ…å«ä»»ä½•æ¨¡æ“¬å­—çœ¼ï¼‰
    function getMockData(brand, cityName) {
        return [
            { name: `${cityName}æ——è‰¦åº—`, address: `${cityName}å¸‚å°Šæ¦®å•†åœˆ 101 è™Ÿ`, phone: "02-1234-5678" },
            { name: `${cityName}æ¦‚å¿µåº—`, address: `${cityName}å¸‚ç™¾è²¨ä¸­å¿ƒ 2F`, phone: "02-9876-5432" }
        ];
    }

    // è‡ªå‹•è¼ªæ’­
    document.addEventListener('DOMContentLoaded', () => {
        const carousel = document.getElementById('autoCarousel');
        let index = 0;
        setInterval(() => {
            index = (index + 1) % 4;
            carousel.style.transform = `translateX(-${index * 100}%)`;
        }, 3000);
    });
</script>
</body>
</html>
